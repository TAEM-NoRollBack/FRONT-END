<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë¸”ë¡œê·¸ ê¸€ì“°ê¸° | write.html</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet" />
<style>
  :root{
    --pink:#FF83A2;
    --pink-soft:#FFCDDA;
    --line:#D9D9D9;
    --text:#000;
    --muted:#777;
    --bg:#fff;
  }
  html,body{margin:0;height:100%;background:#fff;font-family:Pretendard,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;}
  .phone{max-width:393px;height:100svh;margin:0 auto;position:relative;background:#fff;box-shadow:0 0 0 1px #eee;display:flex;flex-direction:column;}
  /* top bar */
  .topbar{position:relative;height:64px;background:var(--pink);border-bottom-left-radius:10px;border-bottom-right-radius:10px;display:flex;align-items:flex-end;padding:8px 12px 10px;}
  .topbar .back{all:unset;cursor:pointer;color:#fff;padding:6px 8px;border-radius:8px}
  .topbar .title{flex:1;text-align:center;color:#000;font-size:18px}
  .topbar .submit{all:unset;cursor:pointer;color:#000;background:#fff;padding:6px 10px;border-radius:14px;border:1px solid var(--pink);font-size:13px}

  /* form */
  .page{flex:1;overflow:auto;padding:14px 16px 88px;}
  .row{margin:10px 0}
  .label{font-size:14px;color:#333;margin-bottom:6px}
  .input, .fake-input{width:100%;border:none;border-bottom:1px solid #000;padding:10px 0;font-size:16px;outline:none}
  .input::placeholder{color:rgba(0,0,0,.44)}
  .help{margin-top:4px;color:rgba(0,0,0,.44);font-size:13px}
  .loc{display:flex;align-items:center;gap:8px;color:rgba(0,0,0,.44);cursor:pointer}
  .loc .pin{width:16px;height:16px;background:var(--pink);-webkit-mask:url('map.svg') center/contain no-repeat;mask:url('map.svg') center/contain no-repeat;opacity:.85} /* ê·¸ëƒ¥ í‘œì‹œìš© */
  .loc .text{border-bottom:1px solid #000;padding:8px 0;flex:1}

  /* rating */
  .rating{display:flex;align-items:center;gap:10px;margin-top:8px}
  .stars{display:flex;gap:6px}
  .star-btn{
    all:unset;cursor:pointer;width:20px;height:20px;display:inline-block;
    background:var(--pink);
    opacity:.25;
    -webkit-mask:url('star.svg') center / contain no-repeat;
            mask:url('star.svg') center / contain no-repeat;
  }
  .star-btn.active{opacity:1}
  .rating .hint{color:rgba(0,0,0,.44);font-size:14px}
  .rating .num{color:#000;font-size:14px;min-width:32px}

  /* gallery */
  .gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
  .thumb{width:100%;aspect-ratio:1.2/1;overflow:hidden;border-radius:10px;border:1px solid #eee;background:#f7f7f7}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}

  /* editor */
  #editor{
    min-height:220px;border-top:1px solid var(--line);padding:12px 2px 8px;font-size:15px;line-height:1.6;outline:none;
    word-break:break-word;
  }
  #editor.align-left{ text-align:left }
  #editor.align-center{ text-align:center }
  #editor.align-right{ text-align:right }
  #editor:empty:before{content:attr(data-placeholder);color:rgba(0,0,0,.44)}

  /* bottom toolbar */
  .toolbar{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:12px;background:#fff;border:1px solid var(--pink);
    display:flex;align-items:center;gap:8px;padding:8px 8px 8px 8px;box-shadow:0 6px 24px rgba(0,0,0,.06);
  }
  .tool{width:36px;height:36px;border:1px solid var(--pink);border-radius:8px;display:grid;place-items:center;cursor:pointer;background:#fff}
  .tool img{width:22px;height:22px;display:block}
  .spacer{flex:1}
  .btn-draft{all:unset;cursor:pointer;font-size:13px;background:#fff;border:1px solid var(--pink);padding:6px 10px;border-radius:8px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:68px;background:#222;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;opacity:0;transition:.25s}
  .toast.show{opacity:1}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:18px}
  .modal .sheet{width:min(360px,100%);max-height:70vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid #eee}
  .sheet header{position:sticky;top:0;background:#fff;padding:12px 14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .sheet header strong{font-size:15px}
  .sheet header button{all:unset;cursor:pointer;color:var(--pink);font-weight:600}
  .list{padding:4px 8px 10px}
  .group-title{margin:12px 6px 6px;font-size:13px;color:#999}
  .item{padding:10px;border:1px solid #eee;border-radius:10px;margin:6px 4px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .item small{color:#777}
  .empty{padding:30px;text-align:center;color:#999}
</style>
</head>
<body>
<div class="phone">
  <div class="topbar">
    <button id="btnBack" class="back">ã€ˆ</button>
    <div class="title">ê²Œì‹œíŒ Â· ì „ì²´ê³µê°œ</div>
    <button id="btnSubmit" class="submit">ë“±ë¡</button>
  </div>

  <div class="page">
    <!-- ì œëª© -->
    <div class="row">
      <input id="title" class="input" placeholder="ì œëª© (ê°€ê²Œì´ë¦„ ì…ë ¥ í•„ìˆ˜)" maxlength="80" />
    </div>

    <!-- ìœ„ì¹˜ -->
    <div class="row">
      <div id="btnPickLocation" class="loc" role="button" tabindex="0" aria-label="ìœ„ì¹˜ ì„ íƒ">
        <span class="pin" aria-hidden="true"></span>
        <div id="placeText" class="text">ìœ„ì¹˜ì¶”ê°€ (ê°€ê²Œìœ„ì¹˜ ë“±ë¡ í•„ìˆ˜)</div>
      </div>
      <div class="help">ìµœê·¼ ë‹¤ë…€ì˜¨ ê°€ê²ŒÂ·ì‹œì¥ì„ ì‚¬ì§„ê³¼ í•¨ê»˜ ê¸°ë¡í•´ë³´ì„¸ìš”.</div>
    </div>

    <!-- ë³„ì  -->
    <div class="row">
      <div class="rating">
        <div id="stars" class="stars" aria-label="ë³„ì  ë§¤ê¸°ê¸°">
          <button class="star-btn" data-val="1" aria-label="1ì "></button>
          <button class="star-btn" data-val="2" aria-label="2ì "></button>
          <button class="star-btn" data-val="3" aria-label="3ì "></button>
          <button class="star-btn" data-val="4" aria-label="4ì "></button>
          <button class="star-btn" data-val="5" aria-label="5ì "></button>
        </div>
        <div class="hint">ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        <div id="ratingNum" class="num"></div>
      </div>
    </div>

    <!-- ì¸ë„¤ì¼ ê°¤ëŸ¬ë¦¬ -->
    <div id="gallery" class="gallery" aria-live="polite"></div>

    <!-- ë³¸ë¬¸ -->
    <div id="editor" class="align-left"
         contenteditable="true"
         data-placeholder="ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ ìœ„ì— ì¸ë„¤ì¼ë¡œ ë¯¸ë¦¬ë³´ê¸°ê°€ ë³´ì—¬ìš”."></div>
  </div>

  <!-- í•˜ë‹¨ íˆ´ë°” -->
  <div class="toolbar" role="toolbar" aria-label="ê¸€ì“°ê¸° ë„êµ¬">
    <button id="btnPickImage" class="tool" title="ì‚¬ì§„ ì—…ë¡œë“œ">
      <img src="picture.svg" alt="ì‚¬ì§„" />
    </button>
    <button id="btnEmpty2" class="tool" title="(ì¤€ë¹„ì¤‘)">
      <img src="text.svg" alt="ì¤€ë¹„ì¤‘" />
    </button>
    <button id="btnAlignLeft" class="tool" title="ì™¼ìª½ ì •ë ¬">
      <img src="left.svg" alt="ì™¼ìª½ì •ë ¬" />
    </button>
    <button id="btnAlignCenter" class="tool" title="ê°€ìš´ë° ì •ë ¬">
      <img src="middle.svg" alt="ê°€ìš´ë°ì •ë ¬" />
    </button>
    <button id="btnAlignRight" class="tool" title="ì˜¤ë¥¸ìª½ ì •ë ¬">
      <img src="right.svg" alt="ì˜¤ë¥¸ìª½ì •ë ¬" />
    </button>
    <button id="btnEmpty6" class="tool" title="(ì¤€ë¹„ì¤‘)">
      <img src="star.svg" alt="ì¤€ë¹„ì¤‘" />
    </button>
    <div class="spacer"></div>
    <button id="btnDraft" class="btn-draft">ì„ì‹œì €ì¥</button>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</div>

<!-- ìˆ¨ê¹€ íŒŒì¼ ì…ë ¥ -->
<input id="fileInput" type="file" accept="image/*" multiple hidden />

<!-- ë”ë¯¸ë°ì´í„° API -->
<script src="../lib/mock-api.js"></script>

<script>
(function(){
  // ---------- state ----------
  const state = {
    place: null,               // { id, type:'market'|'place', name }
    rating: 0,
    images: [],                // dataURL[]
    align: 'left'
  };

  const $ = (sel, el=document)=> el.querySelector(sel);
  const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));

  const el = {
    title: $('#title'),
    placeText: $('#placeText'),
    btnPickLocation: $('#btnPickLocation'),
    starsWrap: $('#stars'),
    ratingNum: $('#ratingNum'),
    editor: $('#editor'),
    gallery: $('#gallery'),
    fileInput: $('#fileInput'),
    btnPickImage: $('#btnPickImage'),
    btnAlignLeft: $('#btnAlignLeft'),
    btnAlignCenter: $('#btnAlignCenter'),
    btnAlignRight: $('#btnAlignRight'),
    btnDraft: $('#btnDraft'),
    btnSubmit: $('#btnSubmit'),
    btnBack: $('#btnBack'),
    toast: $('#toast')
  };

  // ---------- helpers ----------
  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add('show');
    setTimeout(()=> el.toast.classList.remove('show'), 1400);
  }

  function stripHTML(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return (tmp.textContent || tmp.innerText || '').trim();
  }

  // ---------- rating ----------
  function renderStars(){
    $$('.star-btn', el.starsWrap).forEach(btn=>{
      const val = Number(btn.dataset.val);
      btn.classList.toggle('active', val <= state.rating);
    });
    el.ratingNum.textContent = state.rating ? state.rating.toFixed(1) : '';
  }
  el.starsWrap.addEventListener('click', e=>{
    const btn = e.target.closest('.star-btn');
    if(!btn) return;
    state.rating = Number(btn.dataset.val);
    renderStars();
  });
  renderStars();

  // ---------- images ----------
  el.btnPickImage.addEventListener('click', ()=> el.fileInput.click());
  el.fileInput.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files || []);
    for(const f of files){
      if(!f.type.startsWith('image/')) continue;
      const dataURL = await fileToDataURL(f);
      state.images.push(dataURL);
    }
    renderGallery();
    e.target.value = ''; // reset for re-select
  });

  function fileToDataURL(file){
    return new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = ()=> res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  function renderGallery(){
    el.gallery.innerHTML = '';
    state.images.forEach(src=>{
      const d = document.createElement('div');
      d.className = 'thumb';
      d.innerHTML = `<img alt="ë¯¸ë¦¬ë³´ê¸°" />`;
      d.querySelector('img').src = src;
      el.gallery.appendChild(d);
    });
  }

  // ---------- align ----------
  function setAlign(a){
    state.align = a;
    el.editor.classList.remove('align-left','align-center','align-right');
    el.editor.classList.add('align-' + a);
  }
  el.btnAlignLeft.onclick   = ()=> setAlign('left');
  el.btnAlignCenter.onclick = ()=> setAlign('center');
  el.btnAlignRight.onclick  = ()=> setAlign('right');

  // ---------- draft (localStorage) ----------
  const DRAFT_KEY = 'draft.write';
  function saveDraft(){
    const draft = {
      title: el.title.value,
      place: state.place,
      rating: state.rating,
      images: state.images,
      align: state.align,
      bodyHTML: el.editor.innerHTML,
      savedAt: Date.now()
    };
    localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    toast('ì„ì‹œì €ì¥ ì™„ë£Œ!');
  }
  function restoreDraft(){
    try{
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      const d = JSON.parse(raw);
      el.title.value = d.title || '';
      state.place = d.place || null;
      setPlaceText(state.place);
      state.rating = d.rating || 0;
      renderStars();
      state.images = Array.isArray(d.images) ? d.images : [];
      renderGallery();
      setAlign(d.align || 'left');
      if (d.bodyHTML) el.editor.innerHTML = d.bodyHTML;
      toast('ì„ì‹œì €ì¥ ë¶ˆëŸ¬ì™”ì–´ìš”');
    }catch(e){}
  }
  el.btnDraft.addEventListener('click', saveDraft);
  restoreDraft();

// ---------- place picker (modal built here) ----------
const modal = createPlaceModal();
document.body.appendChild(modal.root);
el.btnPickLocation.addEventListener('click', ()=> modal.open());

function setPlaceText(place){
  if (!place){
    el.placeText.textContent = 'ìœ„ì¹˜ì¶”ê°€ (ê°€ê²Œìœ„ì¹˜ ë“±ë¡ í•„ìˆ˜)';
    el.placeText.style.color = 'rgba(0,0,0,.44)';
  } else {
    el.placeText.textContent = place.name;
    el.placeText.style.color = '#000';
  }
}

function createPlaceModal(){
  const root = document.createElement('div');
  root.className = 'modal';
  root.innerHTML = `
    <div class="sheet" role="dialog" aria-modal="true">
      <header><strong>ìœ„ì¹˜ ì„ íƒ</strong><button data-close>ë‹«ê¸°</button></header>
      <div class="list">
        <div class="group-title">ì „í†µì‹œì¥</div>
        <div class="group" data-group="markets"></div>
        <div class="group-title">ìƒì </div>
        <div class="group" data-group="places"></div>
      </div>
    </div>
  `;

  function render(){
    const school  = window.MockAPI.resolveSchool(window.MockAPI.getSchoolSaved()) || {lat:37.42, lng:127.1265, radius:5_000};
    const markets = window.MockAPI.listMarketsNear(school);
    const places  = window.MockAPI.listPlaces();

    const gM = root.querySelector('[data-group="markets"]');
    const gP = root.querySelector('[data-group="places"]');
    gM.innerHTML = markets.map(m=>`
      <div class="item" data-type="market" data-id="${m.id}">
        <div>${m.name} <small>Â· ${Math.round(m.distance_m)}m</small></div>
        <small>${m.area||''}</small>
      </div>`).join('') || `<div class="empty">ê·¼ì²˜ ì‹œì¥ ì—†ìŒ</div>`;
    gP.innerHTML = places.map(p=>`
      <div class="item" data-type="place" data-id="${p.id}">
        <div>${p.name} <small>Â· ${p.category||''}</small></div>
        <small>â­ ${p.rating}</small>
      </div>`).join('') || `<div class="empty">ë“±ë¡ëœ ìƒì  ì—†ìŒ</div>`;
  }

  root.addEventListener('click', (e)=>{
    if(e.target.matches('[data-close]')) close();
    const it = e.target.closest('.item');
    if(it){
      const type = it.dataset.type;
      const id   = it.dataset.id;
      if (type === 'market'){
        const school = window.MockAPI.resolveSchool(window.MockAPI.getSchoolSaved()) || {lat:37.42, lng:127.1265, radius:5_000};
        const m = window.MockAPI.listMarketsNear(school).find(x=>x.id===id) || {id, name:'ì‹œì¥'};
        state.place = { id: m.id, type:'market', name: m.name };
      } else {
        const p = window.MockAPI.listPlaces().find(x=>x.id===id) || {id, name:'ê°€ê²Œ'};
        state.place = { id: p.id, type:'place', name: p.name };
      }
      setPlaceText(state.place);
      close();
    }
  });

  function open(){ render(); root.style.display='flex'; }
  function close(){ root.style.display='none'; }

  return { root, open, close };
}

// ---------- submit & back ----------
el.btnSubmit.addEventListener('click', ()=>{
  const title = el.title.value.trim();
  const body  = el.editor.innerHTML;
  const bodyText = stripHTML(body);

  if (!title){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); el.title.focus(); return; }
  if (!state.place){ alert('ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); el.btnPickLocation.focus(); return; }
  if (!state.rating){ alert('ë³„ì ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  if (!bodyText){ alert('ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.'); el.editor.focus(); return; }

  // ğŸ“Œ board.htmlì´ ì½ëŠ” ìŠ¤í‚¤ë§ˆ/í‚¤ë¡œ ì €ì¥
  const post = {
    id: 'post_' + Date.now(),
    author: 'ë‚˜',               // í•„ìš”í•˜ë©´ ë‹‰ë„¤ì„ìœ¼ë¡œ êµì²´
    createdAt: Date.now(),      // ìˆ«ì íƒ€ì„ìŠ¤íƒ¬í”„
    title,
    content: bodyText,          // í…ìŠ¤íŠ¸ ë³¸ë¬¸(ë³´ë“œê°€ ì‚¬ìš©í•˜ëŠ” í•„ë“œ)
    images: state.images.slice(),
    likes: 0,
    comments: 0,

    // ì¶”ê°€ ë©”íƒ€(ìš°ë¦¬ ì—ë””í„°ìš©)
    place: state.place,
    rating: state.rating,
    align: state.align,
    bodyHTML: body
  };

  // ğŸ”‘ ë³´ë“œì™€ ë™ì¼í•œ í‚¤ë¡œ ì €ì¥
  const STORAGE_KEY = 'BOARD_POSTS';
  const all = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  all.unshift(post);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(all));

  // ìœ„ì¹˜ë³„ ì¸ë±ìŠ¤ëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€
  const key = `posts.place.${state.place.id}`;
  const idx = JSON.parse(localStorage.getItem(key) || '[]');
  idx.unshift(post.id);
  localStorage.setItem(key, JSON.stringify(idx));

  // ì´ˆì•ˆ ì œê±° & ì´ë™
  localStorage.removeItem(DRAFT_KEY);
  location.href = 'board.html';
});


  el.btnBack.addEventListener('click', ()=>{
    const hasContent = el.title.value.trim() || stripHTML(el.editor.innerHTML) || state.images.length || state.rating || state.place;
    if(!hasContent){
      location.href = 'board.html';
      return;
    }
    if (confirm('ê¸€ì“°ê¸°ë¥¼ ì¤‘ë‹¨í• ê¹Œìš”? (ì„ì‹œì €ì¥ì„ ëˆŒëŸ¬ë‘ë©´ ë‚˜ì¤‘ì— ì´ì–´ ì“¸ ìˆ˜ ìˆì–´ìš”)')){
      location.href = 'board.html';
    }
  });

  // ---------- accessibility niceties ----------
  $('#btnEmpty2').addEventListener('click', ()=> toast('ì¤€ë¹„ì¤‘ ê¸°ëŠ¥ì´ì—ìš”!'));
  $('#btnEmpty6').addEventListener('click', ()=> toast('ì¤€ë¹„ì¤‘ ê¸°ëŠ¥ì´ì—ìš”!'));
})();
</script>
</body>
</html>
